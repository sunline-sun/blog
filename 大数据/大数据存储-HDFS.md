#### 移动计算比移动数据更划算

- 普通互联网场景下，是针对单个用户的请求，请求之间是独立的，所以可以通过不同后端服务器处理请求、

- 大数据应用下，处理的大部分事离线数据和存量数据，数据规模都是PB级的，并且数据分布在集群中后，所有数据都是互相有联系的，所以将程序分发到数据所在的地方进行计算更加划算
- 很多移动计算例子，如java通过反射加载网络上的代码，或者杀毒软件从服务器更新病毒库而不是把数据传到服务器查杀



#### 移动计算实现方式

1. 将待处理的大规模数据存储在服务器集群上，主要使用HDFS分布式文件存储系统，将文件文成很多块（Block），以块为单位存储在集群的服务器上。
2. 大数据引擎根据集群里不同服务器的计算能力，在每台服务器上启动若干分布式任务执行进程，这些进程会等待给他们分布任务
3. 使用大数据计算框架支持的变成模型进行变成，比如Hadoop的MapReduce模型，或者Spark的RDD变成模型，都是个jar包
4. 执行Jar包，首先执行引擎会解析程序要处理的数据输入路径，根据输入数据量的大小，将数据分为若干片，每个数据片分配给一个任务执行进程处理
5. 任务执行进程收到分配的任务后，检查自己是否有任务对应的程序包，如果没有就下载，下载后反射方式加载程序
6. 加载程序后，任务执行进程根据分配的数据片的文件地址和数据在数据在文件内的偏移量读取数据，并把数据输入给应用程序相应的方法去执行，从而实现分布式服务器集群中移动计算程序，对大规模数据进行并行处理。



### 大数据存储

#### 如何存储大文件

- 单机时代，RAID（独立磁盘冗余阵列）
- 分布式时代，分布式文件系统

##### 存储大规模数据需要解决的问题

- 数据存储容量的问题
- 数据读写速度的问题
- 数据可靠性的问题

##### RAID解决方案

- RAID是将多块普通磁盘组成一个阵列，同时对外提供服务。主要为了改善磁盘的存储容量、读写速度，增强磁盘的可用性和容错能力。
- 常用RAID技术有下面几种：（磁盘数量为N）

![img](https://static001.geekbang.org/resource/image/54/af/54e170b7438fe3b8f8196dbfbc943baf.jpg?wh=582*150)



![img](https://static001.geekbang.org/resource/image/e2/2f/e2fb7ec97e6127c1b03e83daeff0232f.jpg?wh=720*184)





- RAID0，数据分为N份，并发写入磁盘
- RAID1，数据分为N/2份，将一份数据写入N/2磁盘，另外一半磁盘备份数据
- RAID10，RAID0+RAID1，数据分为N/2份，并发写入N/2磁盘，另外一半磁盘备份数据
- RAID5，数据分为N-1份，并发写入N-1磁盘，螺旋式将校验数据写入所有磁盘，有磁盘故障后根据其他磁盘恢复
- RAID6，数据分为N-2份，并发写入N-2磁盘，螺旋式将校验数据写入两个磁盘，互为备份

##### RAID解决问题方式

- 数据存储容量问题，使用N块磁盘
- 数据读写速度问题，并发写入多块磁盘
- 数据可靠性，通过数据冗余或者存储校验信息，某块磁盘出问题后，可以根据其他磁盘上的数据和校验数据恢复





#### 垂直伸缩到水平伸缩

- 垂直伸缩：提高服务器配置，如RAID，通过在一台服务器上集成更多的磁盘实现更快、更大规模、更安全的存储
- 水平伸缩：增加机器，如HDFS





#### HDFS

和RAID思路一样，HDFS是在一个大规模分布式服务集群上，对数据分片后进行并行读写及冗余存储。

![img](https://static001.geekbang.org/resource/image/65/d7/65efd126cbcf3930a706f64c6e6457d7.jpg?wh=1920*1142)

- DataNode负责文件数据的存储和读写操作，DataNode就是一台服务器，一个DataNode里会有多个磁盘，HDFS将文件数据分隔成若干数据块（Block），每个DataNode存储一部分数据块。
- 客户端可以并行对数据块进行访问，提升访问速度。
- NameNode负责整个分布式系统的元数据（MetaData）管理，也就是文件名、数据块的ID、存储位置等信息，相当于操作系统中文件分配表（FAT）的角色。

![img](https://static001.geekbang.org/resource/image/6f/ac/6f2faa48524251ad77e55e3565095bac.jpg?wh=720*404)



#### HDFS解决问题方式

- 数据存储容量问题，数据分为若干数据块存储到不同服务器上
- 数据读写速度问题，不同分片的数据可以并行读写，一个分片分配一个计算进程。
- 数据可靠性，高可用设计如下

#### HDFS高可用设计

- 数据存储故障容错
  - 为了方式磁盘老化导致的数据错乱，HDFS对于存储在DataNode上的数据块，计算并存储校验和，在读取数据时，重新计算读取数据的校验和，如果校验不正确就抛出异常，去其他DataNode上读取备份数据。
- 磁盘故障容错
  - 如果DataNode检测到本机的某块磁盘损坏，就将该块磁盘上存储的所有BlockID报告给NameNode，NameNode检测这些数据块还在哪些DataNode上有备份，通知相应的DataNode服务器将对应的数据块复制到其他服务器上。
- DataNode故障容错
  - DataNode会通过心跳和NameNode保持通信，如果DataNode超时未发送心跳，NameNode会认为DataNode已经宕机，查找这个DataNode下的数据块，找到备份服务器，再复制一份，保证备份数符合用户设置数目
- NameNode故障容错
  - NameNode是HDFS核心，采用主从热备的方式提供高可用服务
  - 集群部署两台NameNode服务器，一台作为主服务器提供服务，一台作为从服务器进行热备，两台服务器通过Zookeeper选举，通过争夺znode锁，决定谁是主服务器，只有主服务器可以向DataNode返回控制信息。
  - 主从NameNode根据共享存储系统Shared Edits同步元数据信息，当主NameNode宕机，从NameNode会通过Zookeeper升级为主服务器，保证HDFS集群的元数据信息，也就是文件分配表信息完整一致。

![img](https://static001.geekbang.org/resource/image/7c/89/7cb2668644c32364beab0b69e60b3689.png?wh=722*470)